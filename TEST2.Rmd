---
title: "TEST2"
output: html_document
---
```{r}
install.packages("igraph")
install.packages("ggraph")
install.packages("widyr")
install.packages("patchwork")
install.packages("textstem")

```

```{r}
library(dplyr)
library(tidytext)
library(stringr)
library(widyr)
library(igraph)
library(ggraph)
library(readxl)

mind_map.f <- function(
  data,
  restaurant_name,
  min_pair_freq = 2,
  keep_ratio = 0.75
) {

  tokens <- data %>%
    filter(restaurant == restaurant_name) %>%
    mutate(
      text = str_to_lower(review),
      text = str_replace_all(text, "[[:punct:]]", " "),
      text = str_trim(text),
      review_id = row_number()
    ) %>%
    unnest_tokens(word, text) %>%
    filter(!word %in% stop_words$word, !is.na(word))

  wp <- tokens %>%
    pairwise_count(word, review_id, sort = TRUE, upper = FALSE) %>%
    filter(n >= min_pair_freq) %>%
    slice_max(n, n = ceiling(nrow(.) * keep_ratio))

  graph <- graph_from_data_frame(wp)

  clusters <- components(graph)$membership
  V(graph)$cluster <- clusters

  cluster_centers <- lapply(split(V(graph)$name, clusters), function(nodes) {
    subgraph <- induced_subgraph(graph, nodes)
    nodes[which.max(degree(subgraph))]
  })

  constellation_df <- do.call(
    rbind,
    lapply(names(cluster_centers), function(cl) {
      center <- cluster_centers[[cl]]
      nodes <- names(clusters[clusters == as.integer(cl)])
      data.frame(
        from = center,
        to = nodes[nodes != center],
        stringsAsFactors = FALSE
      )
    })
  )

  constellation_graph <- graph_from_data_frame(constellation_df)

  ggraph(constellation_graph, layout = "fr") +
    geom_edge_fan(
      color = "gray60",
      alpha = 0.4,
      lineend = "round"
    ) +
    geom_node_point(
      color = "steelblue3",
      size = 2
    ) +
    geom_node_text(
      aes(label = name),
      repel = TRUE,
      size = 4
    ) +
    theme_void()
}

```

```{r}
library(readxl)

reviews <- read_excel("maindataset.xlsx")

mind_map.f(
  data = reviews,
  restaurant_name = "Mayur_Indian_Kitchen")
```



